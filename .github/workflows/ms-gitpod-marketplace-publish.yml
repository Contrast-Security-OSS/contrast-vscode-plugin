name: Publish VS Code Extension

on:
  push:
    branches: [ "feature/phase-4" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_publish:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install

      # 4Ô∏è‚É£ Build extension
      - name: Build extension
        run: npm run build
        
      # 5Ô∏è‚É£ Run tests
      - name: Run tests
        run: npx jest || echo "No tests found"
        
      - name: Install xvfb
        run: sudo apt-get install -y xvfb

      - name: Start Xvfb
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &

      - name: Run Basic Health Check
        env:
          DISPLAY: :99
        run: npm run uitest

      # 6Ô∏è‚É£ Version bump x.y.z
      - name: Bump version
        id: bump
        run: |
          node <<'EOF'
          const fs = require("fs");

          function bumpVersion(currentVersion) {
            let [x, y, z] = currentVersion.split('.').map(Number);
            z++;
            if (z > 9) { z = 0; y++; }
            if (y > 9) { y = 0; x++; }
            return `${x}.${y}.${z}`;
          }

          const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
          const newVersion = bumpVersion(pkg.version);
          pkg.version = newVersion;

          fs.writeFileSync("package.json", JSON.stringify(pkg, null, 2) + "\n");
          fs.writeFileSync(process.env.GITHUB_OUTPUT, `version=${newVersion}\n`, { flag: "a" });
          EOF
          
      # 7Ô∏è‚É£ Ensure vsce installed
      - name: Ensure vsce is installed
        run: |
          if ! command -v vsce &> /dev/null; then
            npm install -g @vscode/vsce
          fi

      # 8Ô∏è‚É£ Package extension
      - name: Package extension
        run: vsce package

      # üîê Validate Microsoft Marketplace Token
      - name: Validate Microsoft Marketplace Token
        run: |
          echo "üîê Validating Microsoft Marketplace token..."
          EXTENSION_ID=$(node -p "require('./package.json').publisher + '.' + require('./package.json').name")
          set +e
          VSCE_PAT=${{ secrets.VS_MARKETPLACE_TOKEN }} npx vsce show $EXTENSION_ID 2>&1
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "‚ùå INVALID Microsoft Marketplace Token"
            exit $exit_code
          fi
          echo "‚úÖ Microsoft Marketplace token is valid"

      # üîê Validate GitPod/OpenVSX Token
      - name: Validate GitPod/OpenVSX Token
        run: |
          echo "üîê Validating GitPod/OpenVSX token..."
          NAMESPACE=$(node -p "require('./package.json').publisher")
          set +e
          output=$(npx ovsx verify-pat $NAMESPACE -p ${{ secrets.GITPOD_MARKETPLACE_TOKEN }} 2>&1)
          exit_code=$?
          echo "$output"

          if [ $exit_code -ne 0 ]; then
            echo "‚ùå INVALID GitPod/OpenVSX Token"
            exit $exit_code
          fi

          echo "‚úÖ GitPod/OpenVSX token is valid for namespace $NAMESPACE"

      # 9Ô∏è‚É£ Check version in BOTH marketplaces
      - name: Check versions in both Marketplaces
        id: check_version
        run: |
          EXTENSION_ID=$(node -p "require('./package.json').publisher + '.' + require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")

          echo "üîç Checking extension: $EXTENSION_ID"
          echo "üîç New version to publish: $VERSION"

          ms_exists=false
          gitpod_exists=false

          echo "üìå Microsoft Marketplace:"
          MS_VERSION=$(npx vsce show $EXTENSION_ID -p "${{ secrets.VS_MARKETPLACE_TOKEN }}" 2>/dev/null | grep "Version:" | awk '{print $2}')
          echo "‚Ä¢ MS Marketplace Version = ${MS_VERSION:-none}"

          if [ "$MS_VERSION" = "$VERSION" ]; then
            ms_exists=true
          fi

          echo "üìå GitPod / OpenVSX:"
          GITPOD_VERSION=$(npx ovsx show $EXTENSION_ID -p "${{ secrets.GITPOD_MARKETPLACE_TOKEN }}" 2>/dev/null | grep "Version:" | awk '{print $2}')
          echo "‚Ä¢ GitPod Version = ${GITPOD_VERSION:-none}"

          if [ "$GITPOD_VERSION" = "$VERSION" ]; then
            gitpod_exists=true
          fi

          if [ "$ms_exists" = true ] || [ "$gitpod_exists" = true ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚õî Version already exists ‚Äî blocking publish."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úî Version safe to publish."
          fi

      # üîü Publish to Microsoft Marketplace (both must publish or none)
      - name: Publish to Visual Studio Marketplace
        if: steps.check_version.outputs.exists == 'false'
        run: |
          echo "Publishing to MS Marketplace..."
          set +e
          output=$(npx vsce publish -p ${{ secrets.VS_MARKETPLACE_TOKEN }} 2>&1)
          exit_code=$?
          echo "$output"

          if echo "$output" | grep -q "already exists"; then
            exit 1
          fi

          if [ $exit_code -ne 0 ]; then
            exit $exit_code
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Publish to GitPod Marketplace (must match MS result)
      - name: Publish to GitPod Marketplace
        if: steps.check_version.outputs.exists == 'false'
        run: |
          echo "‚è≥ Publishing to GitPod Marketplace..."
          set +e
          output=$(npx ovsx publish -p ${{ secrets.GITPOD_MARKETPLACE_TOKEN }} 2>&1)
          exit_code=$?
          echo "$output"

          if echo "$output" | grep -q "already exists"; then
            exit 1
          fi

          if [ $exit_code -ne 0 ]; then
            echo "‚ùå GitPod publish failed ‚Äî aborting to prevent version mismatch."
            exit $exit_code
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Commit version bump
      - name: Commit and push version bump
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "Bump version to ${{ steps.bump.outputs.version }}" || echo "No changes"
          git push origin HEAD:${GITHUB_REF_NAME}

      # 1Ô∏è‚É£3Ô∏è‚É£ Upload artifact
      - name: Upload VSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ steps.bump.outputs.version }}
          path: "*.vsix"
