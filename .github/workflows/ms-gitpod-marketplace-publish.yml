name: Publish VS Code Extension

on:
  push:
    branches: [ "feature/phase-4" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_publish:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      # 2Ô∏è‚É£ Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install

      # 4Ô∏è‚É£ Build extension
      - name: Build extension
        run: npm run build
        
      # 7Ô∏è‚É£ Ensure vsce installed
      - name: Ensure vsce is installed
        run: |
          if ! command -v vsce &> /dev/null; then
            npm install -g @vscode/vsce
          fi

      # 8Ô∏è‚É£ Package extension
      - name: Package extension
        run: vsce package

      # üîê Validate Microsoft Marketplace Token
      - name: Validate Microsoft Marketplace Token (dry-run)
        run: |
          echo "üîê Validating Microsoft Marketplace token..."
          set +e
          output=$(npx vsce publish --dry-run -p ${{ secrets.VS_MARKETPLACE_TOKEN }} 2>&1)
          exit_code=$?
          echo "$output"

          if [ $exit_code -ne 0 ]; then
            echo "‚ùå INVALID Microsoft Marketplace Token"
            exit $exit_code
          fi

          echo "‚úÖ Microsoft Marketplace token is valid for publishing"

      # üîê Validate GitPod/OpenVSX Token
      - name: Validate GitPod/OpenVSX Token
        run: |
          echo "üîê Validating GitPod/OpenVSX token..."
          set +e
          output=$(npx ovsx whoami -p ${{ secrets.GITPOD_MARKETPLACE_TOKEN }} 2>&1)
          exit_code=$?
          echo "$output"

          if [ $exit_code -ne 0 ]; then
            echo "‚ùå INVALID GitPod/OpenVSX Token"
            exit $exit_code
          fi

          echo "‚úÖ GitPod/OpenVSX token is valid"

      # 9Ô∏è‚É£ Check version in BOTH marketplaces
      - name: Check versions in both Marketplaces
        id: check_version
        run: |
          EXTENSION_ID=$(node -p "require('./package.json').publisher + '.' + require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")

          echo "üîç Checking extension: $EXTENSION_ID"
          echo "üîç New version to publish: $VERSION"
          echo ""

          ms_exists=false
          gitpod_exists=false

          echo "üìå Microsoft Marketplace:"
          MS_VERSION=$(npx vsce show $EXTENSION_ID -p "${{ secrets.VS_MARKETPLACE_TOKEN }}" 2>/dev/null | grep "Version:" | awk '{print $2}')

          if [ -z "$MS_VERSION" ]; then
            echo " ‚ùå Not published on Microsoft Marketplace"
          else
            echo " ‚úÖ Current version on MS Marketplace = $MS_VERSION"
            if [ "$MS_VERSION" = "$VERSION" ]; then ms_exists=true; fi
          fi

          echo ""
          echo "üìå GitPod / OpenVSX Marketplace:"
          GITPOD_VERSION=$(npx ovsx show $EXTENSION_ID -p "${{ secrets.GITPOD_MARKETPLACE_TOKEN }}" 2>/dev/null | grep "Version:" | awk '{print $2}')

          if [ -z "$GITPOD_VERSION" ]; then
            echo " ‚ùå Not published on GitPod/OpenVSX"
          else
            echo " ‚úÖ Current version on GitPod/OpenVSX = $GITPOD_VERSION"
            if [ "$GITPOD_VERSION" = "$VERSION" ]; then gitpod_exists=true; fi
          fi

          echo ""
          echo "-----------------------------------------"
          echo "üß™ Comparing with new version: $VERSION"
          echo "-----------------------------------------"

          if [ "$ms_exists" = true ] || [ "$gitpod_exists" = true ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚õî Version $VERSION already exists ‚Äî blocking publish."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úî Version $VERSION does NOT exist ‚Äî safe to publish."
          fi

      # üîü Publish to Microsoft Marketplace (both must publish or none)
      - name: Publish to Visual Studio Marketplace
        if: steps.check_version.outputs.exists == 'false'
        run: |
          echo "Publishing to MS Marketplace..."
          set +e
          output=$(npx vsce publish -p ${{ secrets.VS_MARKETPLACE_TOKEN }} 2>&1)
          exit_code=$?
          echo "$output"

          if echo "$output" | grep -q "already exists"; then
            exit 1
          fi

          if [ $exit_code -ne 0 ]; then
            exit $exit_code
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Publish to GitPod Marketplace (must match MS result)
      - name: Publish to GitPod Marketplace
        if: steps.check_version.outputs.exists == 'false'
        run: |
          echo "‚è≥ Publishing to GitPod Marketplace..."
          set +e
          output=$(npx ovsx publish -p ${{ secrets.GITPOD_MARKETPLACE_TOKEN }} 2>&1)
          exit_code=$?
          echo "$output"

          if echo "$output" | grep -q "already exists"; then
            exit 1
          fi

          if [ $exit_code -ne 0 ]; then
            echo "‚ùå GitPod publish failed ‚Äî aborting to prevent version mismatch."
            exit $exit_code
          fi
      
      # 1Ô∏è‚É£2Ô∏è‚É£ Commit version bump
      - name: Commit and push version bump
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json package-lock.json
          git commit -m "Bump version to ${{ steps.bump.outputs.version }}" || echo "No changes"
          git push origin HEAD:${GITHUB_REF_NAME}

      # 1Ô∏è‚É£3Ô∏è‚É£ Upload artifact
      - name: Upload VSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ steps.bump.outputs.version }}
          path: "*.vsix"
