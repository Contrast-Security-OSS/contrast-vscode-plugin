/* eslint-disable @typescript-eslint/no-explicit-any */
import React, { FC, useEffect, useState } from 'react';
import WarningOutlinedIcon from '@mui/icons-material/WarningOutlined';
import { CustomLibraryVulnerability } from '../../../common/types';
import {
  LibParsedVulnerability,
  LibraryNode,
} from '../../../vscode-extension/api/model/api.interface';
import RestrictedLibrariesIcon from '../../../../assets/restrictedLibraries.png';
import RestrictedLicensesIcon from '../../../../assets/restrictedLicenses.png';
import OutdatedLibraryIcon from '../../../../assets/outdatedLibrary.png';
import { Tooltip } from '@mui/material';
interface PaneHeaderProps {
  node: CustomLibraryVulnerability;
  parentNode?: LibraryNode;
  onArrowClick: () => void;
  isExpanded: boolean;
  onSelect: (payload: any) => void;
}

interface TreeViewProps {
  treeData: LibParsedVulnerability[];
  parentNode?: LibraryNode;
  indent: number;
  onSelect: (payload: any) => void;
}

interface NodeBodyProps {
  childrenNodes: any[];
  parentNode: LibraryNode;
  indent: number;
  onSelect: (payload: any) => void;
}

interface NodeRowProps {
  node: any;
  parentNode?: LibraryNode;
  indent: number;
  onSelect: (payload: any) => void;
}

export const PaneHeader: FC<PaneHeaderProps> = ({
  node,
  onArrowClick,
  isExpanded,
  onSelect,
}) => {
  const { cveCount, label, child, overview, level } = node;
  const [arrowDirection, setArrowDirection] = useState('fa fa-angle-right');

  useEffect(() => {
    setArrowDirection(isExpanded ? 'fa fa-angle-down' : 'fa fa-angle-right');
  }, [isExpanded]);

  const handleClick = () => {
    onSelect(node);
  };

  const getSeverityColor = (severity: string) => {
    switch (severity.toUpperCase()) {
      case 'CRITICAL':
        return 'red';
      case 'HIGH':
        return 'orange';
      case 'MEDIUM':
        return 'yellow';
      case 'LOW':
        return 'gray';
      case 'NOTE':
        return 'lightgray';
      default:
        return 'red';
    }
  };
  const getPolicyViolations = (): JSX.Element | null => {
    if (node === null || node === undefined) {
      return null;
    }

    const policyMap: Record<string, { tooltip: string; icon: string }> = {
      restrictedLicenses: {
        tooltip: 'Organization prohibits use of this license.',
        icon: RestrictedLicensesIcon,
      },
      restrictedLibraries: {
        tooltip:
          'This is a restricted library and is flagged as a library policy violation.',
        icon: RestrictedLibrariesIcon,
      },
      outdatedLibrary: {
        tooltip:
          'Your organization requires up-to-date libraries to ensure compatibility and security. Please update and use the latest library available.',
        icon: OutdatedLibraryIcon,
      },
    };

    const activePolicies = (
      Object.keys(policyMap) as (keyof typeof policyMap)[]
    ).filter((key) => node[key as keyof typeof node] === true);

    if (activePolicies.length === 0) {
      return null;
    }

    return (
      <div
        style={{ display: 'flex', gap: 8, alignItems: 'center', marginLeft: 8 }}
      >
        {activePolicies.map((policy) => {
          const { tooltip, icon } = policyMap[policy];
          return (
            <Tooltip title={tooltip} key={policy}>
              <img src={icon} alt={policy} height={16} />
            </Tooltip>
          );
        })}
      </div>
    );
  };

  return (
    <div className="pane-header" role="pane">
      {node.id}
      {child !== null && child?.length > 0 && (
        <i
          className={arrowDirection}
          style={{ fontSize: '20px' }}
          aria-hidden="true"
          onClick={onArrowClick}
        ></i>
      )}
      {overview?.severity !== null && overview?.severity !== undefined && (
        <>
          <WarningOutlinedIcon
            data-testid="warning-icon"
            fontSize="small"
            style={{
              color: getSeverityColor(overview?.severity as unknown as string),
            }}
          />
        </>
      )}
      <div onClick={handleClick}>{label}</div>
      {cveCount !== null && cveCount !== undefined && (
        <div style={{ color: 'gray' }}>({cveCount}) CVE's</div>
      )}
      {level === 1 && getPolicyViolations()}
    </div>
  );
};

const NodeBody: FC<NodeBodyProps> = ({
  childrenNodes,
  parentNode,
  indent,
  onSelect,
}) => {
  return (
    <>
      {childrenNodes?.length > 0 && (
        <TreeView
          treeData={childrenNodes}
          parentNode={parentNode}
          indent={indent}
          onSelect={onSelect}
        />
      )}
    </>
  );
};

const NodeRow: FC<NodeRowProps> = ({
  node,
  parentNode,
  indent = 0,
  onSelect,
}) => {
  const { child, level } = node;
  const [isExpanded, setIsExpanded] = useState(false);

  useEffect(() => {
    if (level === 2) {
      setIsExpanded(true);
    }
  }, [level]);

  return (
    <div style={{ marginLeft: `${indent}px` }} className="head">
      <PaneHeader
        node={node}
        parentNode={parentNode}
        onArrowClick={() => setIsExpanded(!isExpanded)}
        isExpanded={isExpanded}
        onSelect={onSelect}
      />
      {child?.length > 0 && isExpanded && (
        <NodeBody
          childrenNodes={child}
          parentNode={node}
          indent={indent + 10}
          onSelect={onSelect}
        />
      )}
    </div>
  );
};

const TreeView: FC<TreeViewProps> = ({
  treeData,
  parentNode,
  indent = 0,
  onSelect,
}) => {
  return (
    <>
      {treeData?.map((node, index) => (
        <div key={index}>
          <NodeRow
            node={node}
            parentNode={parentNode}
            indent={indent}
            onSelect={onSelect}
          />
        </div>
      ))}
    </>
  );
};

const ScaVulnerabilityReport: FC<{
  treeData: LibParsedVulnerability[];
  onSelect: (payload: any) => void;
}> = ({ treeData, onSelect }) => {
  return (
    <div>
      <TreeView treeData={treeData} indent={10} onSelect={onSelect} />
    </div>
  );
};

export { ScaVulnerabilityReport };
