/* eslint-disable @typescript-eslint/no-explicit-any */
/* eslint-disable @typescript-eslint/strict-boolean-expressions */
import axios from 'axios';
import { resolveFailure } from '../../../vscode-extension/utils/errorHandling';
import { l10n } from '../../../l10n';
import { GetAllConfiguredProjects } from '../../../vscode-extension/persistence/PersistenceConfigSetting';
import { getScanVulnerabilityResults } from '../../../vscode-extension/api/services/apiService';
import { getAllAssessFilters } from '../../../vscode-extension/utils/helper';
import MockAdapter from 'axios-mock-adapter';

jest.mock('axios');
jest.mock('axios-retry', () => {
  return jest.fn();
});

jest.mock('../../../vscode-extension/api/services/apiService', () => ({
  ...jest.requireActual('../../../vscode-extension/api/services/apiService'),

  getApplicationById: jest.fn(),
}));

jest.mock('../../../vscode-extension/cache/backgroundRefreshTimer', () => ({
  startBackgroundTimer: jest.fn(),
  stopBackgroundTimer: jest.fn(),
}));

jest.mock(
  '../../../vscode-extension/cache/backgroundRefreshTimerAssess',
  () => ({
    startBackgroundTimerAssess: jest.fn(),
    stopBackgroundTimerAssess: jest.fn(),
  })
);

jest.mock(
  '../../../vscode-extension/persistence/PersistenceConfigSetting',
  () => ({
    GetAllConfiguredProjects: jest.fn(),
  })
);

jest.mock('../../../vscode-extension/utils/helper', () => ({
  getAllAssessFilters: jest.fn(),
}));

// Put this before any imports that use 'vscode', or move to __mocks__/vscode.ts and call `jest.mock('vscode')`.
jest.mock(
  'vscode',
  () => {
    const path = require('path');

    const disposable = () => ({ dispose: jest.fn() });

    const UIKind = { Desktop: 1, Web: 2 };

    const Uri = {
      file: jest.fn((p: string) => ({ fsPath: p, path: p, toString: () => p })),
      joinPath: jest.fn((base: any, ...segs: string[]): any => {
        const basePath = typeof base === 'string' ? base : base.fsPath;
        return Uri.file(path.join(basePath, ...segs));
      }),
    };

    class TreeItem {
      label: any;
      command?: { title: string; command: string };
      iconPath?: { dark: any; light: any };
      constructor(label: any, command: any = null, icon: any = null) {
        this.label = label;
        if (command) {
          this.command = {
            title: typeof label === 'string' ? label : 'Command',
            command,
          };
        }
        if (icon) {
          const iconPath = Uri.file(path.join(process.cwd(), 'assets', icon));
          this.iconPath = { dark: iconPath, light: iconPath };
        }
      }
    }

    return {
      UIKind,
      version: '1.93.0',
      Uri,

      env: {
        language: 'en',
        appName: 'VSCode',
        uiKind: UIKind.Desktop,
      },

      workspace: {
        workspaceFolders: [{ uri: { fsPath: '/path/to/mock/workspace' } }],
        onDidChangeConfiguration: jest.fn(() => disposable()),
        getConfiguration: jest.fn(() => ({
          get: jest.fn(),
          update: jest.fn(),
        })),
      },

      window: {
        activeTextEditor: { document: { fileName: 'test.js' } },
        createTreeView: jest.fn(() => ({
          onDidChangeVisibility: jest.fn(),
          reveal: jest.fn(),
          dispose: jest.fn(),
        })),
        showErrorMessage: jest.fn(),
        showInformationMessage: jest.fn(),
      },

      commands: {
        registerCommand: jest.fn(() => disposable()),
        executeCommand: jest.fn(),
      },

      // <-- This was missing
      languages: {
        registerHoverProvider: jest.fn(() => disposable()),
      },

      TreeItem,
    };
  },
  { virtual: true }
);

jest.mock(
  '../../../vscode-extension/commands/ui-commands/webviewHandler',
  () => ({
    ContrastPanelInstance: {
      postMessage: jest.fn(),
    },
  })
);

jest.mock('../../../vscode-extension/logging/logger', () => ({
  loggerInstance: {
    logMessage: jest.fn(),
  },
}));

jest.mock(
  '../../../vscode-extension/commands/ui-commands/messageHandler',
  () => ({
    ShowInformationPopupWithOptions: jest.fn(),
    ShowInformationPopup: jest.fn(),
    ShowErrorPopup: jest.fn(),
  })
);

jest.mock('../../../vscode-extension/utils/errorHandling', () => ({
  resolveSuccess: jest.fn(),
  resolveFailure: jest.fn(),
}));

// const mockedAxios = axios as jest.Mocked<typeof axios>;
const localeI18n = new l10n('en');

describe('getScanVulnerabilityResults', () => {
  let mockAxios: MockAdapter;
  const mockAppId = 'app123';
  const mockConfiguredProject = {
    projectId: '456-ABC-789-XYZ',
    contrastURL: 'https://xyz.com',
    userName: 'xyz@xyz.com',
    serviceKey: 'ABCDEFGHIJ',
    apiKey: 'PQRS1234TUV5678',
    organizationId: '123-XYZ-456-ABC-789',
    source: 'assess',
  };

  beforeEach(() => {
    mockAxios = new MockAdapter(axios as any);
    jest.clearAllMocks();

    (GetAllConfiguredProjects as jest.Mock).mockResolvedValue({
      responseData: [mockConfiguredProject],
    });

    (getAllAssessFilters as jest.Mock).mockResolvedValue({
      responseData: null,
    });
  });

  afterEach(() => {
    mockAxios.restore();
  });

  it('should return failure if project not found', async () => {
    (GetAllConfiguredProjects as jest.Mock).mockResolvedValue({
      responseData: [],
    });

    const result = await getScanVulnerabilityResults(mockAppId);

    expect(result).toEqual(
      resolveFailure(
        localeI18n.getTranslation('apiResponse.projectNotFound'),
        400
      )
    );
  });

  it('should return failure if project is not found from configured list', async () => {
    const result = await getScanVulnerabilityResults('nonExistingProjectId');

    expect(result).toEqual(
      resolveFailure(
        localeI18n.getTranslation('apiResponse.projectNotFound'),
        400
      )
    );
  });
});
